<%- include('partials/header', { title: `Book: ${event.title}` }) %>

<div class="max-w-3xl mx-auto py-8">
  <h1 class="text-3xl font-bold mb-4">Attend: <%= event.title %></h1>
  <p class="text-gray-700 mb-6"><%= event.description %></p>
  <p class="mb-6"><strong>Date:</strong> <%= new Date(event.event_date).toLocaleDateString() %></p>

  <!-- Display server-side validation errors -->
  <% if (errors.length) { %>
    <ul class="mb-4 text-red-600 list-disc list-inside">
      <% errors.forEach(e => { %>
        <li><%= e.msg %></li>
      <% }) %>
    </ul>
  <% } %>

  <form id="booking-form" action="/attendee/events/<%= event.id %>/book" method="post">
    <div class="mb-4">
      <label class="block font-medium mb-1" for="name">Your Name</label>
      <input
        type="text" name="name" id="name"
        value="<%= formData.name||'' %>"
        class="w-full border rounded px-3 py-2"
        required
      />
    </div>

    <fieldset class="mb-6 space-y-4">
      <legend class="font-semibold">Select Tickets</legend>
      <% tickets.forEach(t => { %>
        <div class="flex items-center space-x-4">
          <div class="w-1/3">
            <p class="font-medium"><%= t.type.charAt(0).toUpperCase() + t.type.slice(1) %></p>
            <p class="text-sm text-gray-500">$<%= t.price.toFixed(2) %> each</p>
            <p class="text-sm text-gray-400">Remaining: <%= t.quantity %></p>
          </div>
          <div class="w-1/3">
            <label class="block text-sm mb-1">Quantity</label>
            <input
              type="number"
              name="tickets[<%= t.id %>][quantity]"
              min="0" max="<%= t.quantity %>"
              value="<%= (formData['tickets['+t.id+'][quantity]']||0) %>"
              class="w-full border rounded px-2 py-1"
            />
          </div>
        </div>
      <% }) %>
    </fieldset>

    <button
      type="submit"
      class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition"
    >
      Book&nbsp;Now
    </button>
    <a href="/attendee" class="ml-4 text-gray-600 hover:underline">‚Üê Back</a>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
// Example: hijack form and submit via Axios for smoother UX
document.getElementById('booking-form').addEventListener('submit', function(e) {
  e.preventDefault();
  const form = e.target;
  const data = new FormData(form);
  axios.post(form.action, data)
    .then(resp => {
      // on success redirect
      window.location.href = '/attendee?booked=1';
    })
    .catch(err => {
      // on error, reload to show server-side messages
      window.location.reload();
    });
});
</script>

<%- include('partials/footer') %>

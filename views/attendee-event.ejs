<%- include('partials/header', { title: `Book: ${event.title}` }) %>

<div class="container mx-auto py-8 max-w-4xl">
  <div class="bg-white rounded-lg shadow-lg overflow-hidden">
    <!-- Event Header -->
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-8">
      <h1 class="text-3xl font-bold mb-2"><%= event.title %></h1>
      <div class="flex items-center text-blue-100">
        <i class="fas fa-calendar mr-2"></i>
        <span class="text-lg">
          <%= new Date(event.event_date).toLocaleDateString('en-GB', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
          }) %>
        </span>
      </div>
    </div>

    <div class="p-8">
      <!-- Event Description -->
      <div class="mb-8">
        <h2 class="text-xl font-semibold text-gray-900 mb-3">
          <i class="fas fa-info-circle mr-2 text-blue-600"></i>
          About This Event
        </h2>
        <p class="text-gray-700 leading-relaxed"><%= event.description %></p>
      </div>

      <!-- Booking Status Messages -->
      <% if (errors.length) { %>
        <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
          <h3 class="text-red-800 font-semibold mb-2">
            <i class="fas fa-exclamation-triangle mr-1"></i>
            Booking Error
          </h3>
          <ul class="list-disc list-inside text-red-700">
            <% errors.forEach(error => { %>
              <li><%= error.msg || error %></li>
            <% }) %>
          </ul>
        </div>
      <% } %>

      <!-- Ticket Booking Form -->
      <form id="booking-form" action="/attendee/events/<%= event.id %>/book" method="post">
        <!-- Customer Information -->
        <div class="mb-8">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">
            <i class="fas fa-user mr-2 text-green-600"></i>
            Your Information
          </h2>
          <div class="bg-gray-50 p-6 rounded-lg">
            <label class="block text-sm font-medium text-gray-700 mb-2" for="name">
              Full Name *
            </label>
            <input
              type="text"
              name="name"
              id="name"
              value="<%= formData.name || '' %>"
              class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter your full name"
              required
            />
          </div>
        </div>

        <!-- Ticket Selection -->
        <div class="mb-8">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">
            <i class="fas fa-ticket-alt mr-2 text-purple-600"></i>
            Select Your Tickets
          </h2>
          
          <% if (tickets.length === 0) { %>
            <div class="text-center py-12 text-gray-500">
              <i class="fas fa-ticket-alt text-4xl mb-4"></i>
              <p>No tickets available for this event.</p>
            </div>
          <% } else { %>
            <div class="space-y-4">
              <% tickets.forEach(ticket => { %>
                <div class="ticket-row bg-gray-50 border border-gray-200 rounded-lg p-6 hover:border-blue-300 transition-colors">
                  <div class="flex flex-col md:flex-row md:items-center justify-between">
                    <div class="flex-1 mb-4 md:mb-0">
                      <h3 class="text-lg font-semibold text-gray-900 mb-1">
                        <%= ticket.type.charAt(0).toUpperCase() + ticket.type.slice(1).replace('-', ' ') %> Tickets
                      </h3>
                      <div class="flex items-center space-x-4 text-sm text-gray-600">
                        <span class="flex items-center">
                          <i class="fas fa-pound-sign mr-1"></i>
                          <span class="font-medium text-lg text-green-600">£<%= ticket.price.toFixed(2) %></span>
                          <span class="ml-1">each</span>
                        </span>
                        <span class="flex items-center">
                          <i class="fas fa-users mr-1"></i>
                          <span class="<%= ticket.quantity === 0 ? 'text-red-600 font-medium' : '' %>">
                            <%= ticket.quantity %> remaining
                          </span>
                        </span>
                      </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                          Quantity
                        </label>
                        <select
                          name="tickets[<%= ticket.id %>][quantity]"
                          class="ticket-quantity border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                          data-price="<%= ticket.price %>"
                          data-ticket-type="<%= ticket.type %>"
                          <% if (ticket.quantity === 0) { %>disabled<% } %>
                        >
                          <% for (let i = 0; i <= Math.min(ticket.quantity, 10); i++) { %>
                            <option value="<%= i %>" 
                              <% if ((formData[`tickets[${ticket.id}][quantity]`] || 0) == i) { %>selected<% } %>>
                              <%= i %>
                            </option>
                          <% }) %>
                        </select>
                      </div>
                      
                      <div class="text-right">
                        <div class="text-sm text-gray-500">Subtotal</div>
                        <div class="ticket-subtotal text-lg font-semibold text-gray-900">£0.00</div>
                      </div>
                    </div>
                  </div>
                  
                  <% if (ticket.quantity === 0) { %>
                    <div class="mt-3 text-sm text-red-600 font-medium">
                      <i class="fas fa-exclamation-circle mr-1"></i>
                      Sold Out
                    </div>
                  <% } %>
                </div>
              <% }) %>
            </div>

            <!-- Order Summary -->
            <div id="order-summary" class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-6" style="display: none;">
              <h3 class="text-lg font-semibold text-gray-900 mb-3">
                <i class="fas fa-receipt mr-2"></i>
                Order Summary
              </h3>
              <div id="summary-items" class="space-y-2 mb-4"></div>
              <div class="border-t border-blue-200 pt-3">
                <div class="flex justify-between items-center text-xl font-bold text-gray-900">
                  <span>Total:</span>
                  <span id="total-amount">£0.00</span>
                </div>
              </div>
            </div>
          <% } %>
        </div>

        <!-- Booking Actions -->
        <div class="flex flex-col sm:flex-row gap-4 pt-6 border-t border-gray-200">
          <button
            type="submit"
            id="book-button"
            class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition duration-200 font-medium disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            <i class="fas fa-credit-card mr-2"></i>
            Book Now
          </button>
          
          <a
            href="/attendee"
            class="flex-1 bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition duration-200 font-medium text-center"
          >
            <i class="fas fa-arrow-left mr-2"></i>
            Back to Events
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const quantitySelects = document.querySelectorAll('.ticket-quantity');
  const orderSummary = document.getElementById('order-summary');
  const summaryItems = document.getElementById('summary-items');
  const totalAmount = document.getElementById('total-amount');
  const bookButton = document.getElementById('book-button');

  function updateOrderSummary() {
    let total = 0;
    let hasTickets = false;
    summaryItems.innerHTML = '';

    quantitySelects.forEach(select => {
      const quantity = parseInt(select.value);
      const price = parseFloat(select.dataset.price);
      const ticketType = select.dataset.ticketType;
      const subtotal = quantity * price;

      // Update individual subtotal display
      const subtotalElement = select.closest('.ticket-row').querySelector('.ticket-subtotal');
      subtotalElement.textContent = `£${subtotal.toFixed(2)}`;

      if (quantity > 0) {
        hasTickets = true;
        total += subtotal;
        
        // Add to summary
        const summaryItem = document.createElement('div');
        summaryItem.className = 'flex justify-between text-sm';
        summaryItem.innerHTML = `
          <span>${quantity}x ${ticketType.charAt(0).toUpperCase() + ticketType.slice(1).replace('-', ' ')}</span>
          <span>£${subtotal.toFixed(2)}</span>
        `;
        summaryItems.appendChild(summaryItem);
      }
    });

    // Show/hide order summary
    orderSummary.style.display = hasTickets ? 'block' : 'none';
    totalAmount.textContent = `£${total.toFixed(2)}`;
    
    // Enable/disable book button
    bookButton.disabled = !hasTickets;
  }

  // Add event listeners to all quantity selects
  quantitySelects.forEach(select => {
    select.addEventListener('change', updateOrderSummary);
  });

  // Initial update
  updateOrderSummary();

  // Form submission with loading state
  const bookingForm = document.getElementById('booking-form');
  bookingForm.addEventListener('submit', function(e) {
    bookButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
    bookButton.disabled = true;
  });
});
</script>

<%- include('partials/footer') %>